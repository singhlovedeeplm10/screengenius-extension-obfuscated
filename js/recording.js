let recordedVideoData="";let recordedVideoBlobData="";let recordedvideoSize="";let recordedVideoDuration="";let recordedVideoUpload=false;let helpers;let extPrefix="SG_";window.addEventListener("focus",event=>{chrome.storage.local.get(`${extPrefix}quixyLoginUserData`,result=>{if(result[`${extPrefix}quixyLoginUserData`]!=""&&result[`${extPrefix}quixyLoginUserData`]!=null){const data=JSON.stringify({access_token:result[`${extPrefix}quixyLoginUserData`].access_token,token_type:"extension"});helpers.makeServerRequest("POST","",helpers.api+"/user/get",data,res=>{helpers.handleUserSession(res,"get")})}else{helpers.handleUserSession({})}})});window.onbeforeunload=event=>{chrome.runtime.sendMessage({type:"closeExtensionRecordingPage"})};window.onload=()=>{helpers=new helperSG;chrome.storage.local.get("watermarkSettings",result=>{if(result.watermarkSettings){helpers.watermarkSettings.length=0;helpers.watermarkSettings.push(result.watermarkSettings);helpers.watermark=true}});chrome.storage.local.get(`${extPrefix}quixyLoginUserData`,function(result){if(result[`${extPrefix}quixyLoginUserData`]!=""&&result[`${extPrefix}quixyLoginUserData`]!=null){const data=JSON.stringify({access_token:result[`${extPrefix}quixyLoginUserData`].access_token,token_type:"extension"});helpers.makeServerRequest("POST","",helpers.api+"/user/get",data,res=>{helpers.handleUserSession(res)})}else{helpers.handleUserSession({})}});chrome.storage.local.get(`${extPrefix}quixyLoginUserData`,result=>{if(result[`${extPrefix}quixyLoginUserData`]!==""&&result[`${extPrefix}quixyLoginUserData`]!==null){jQuery(".loggedin-item").show();jQuery(".loggedOut-item").hide()}else{jQuery(".loggedin-item").hide();jQuery(".loggedOut-item").show()}});chrome.storage.local.get(`${extPrefix}recordedVideoDuration`,async obj=>{recordedVideoDuration=obj[`${extPrefix}recordedVideoDuration`];jQuery(".recording-duration").text(recordedVideoDuration)});chrome.storage.local.get(`${extPrefix}recordedVideoData`,async obj=>{fetch(obj[`${extPrefix}recordedVideoData`]).then(response=>response.blob()).then(blobData=>{this.saveBlobData(blobData);setTimeout(function(){getBlobData(function(data){const href=URL.createObjectURL(data[0]);recordedVideoBlobData=data[0];recordedVideoData=href;jQuery("#video-download-content-left-inner video").attr("src",recordedVideoData)})},100)})["catch"](error=>{console.error("Error fetching blob data:",error);getBlobData(function(data){const href=URL.createObjectURL(data[0]);recordedVideoBlobData=data[0];recordedVideoData=href;jQuery("#video-download-content-left-inner video").attr("src",recordedVideoData)})})});chrome.storage.local.get(`${extPrefix}recordedvideoSize`,async obj=>{recordedvideoSize=obj[`${extPrefix}recordedvideoSize`];jQuery(".recording-size").text(helpers.formatBytes(recordedvideoSize));jQuery(".recording-date").text(helpers.getTodayDate())});chrome.storage.local.get(`${extPrefix}recordedVideoUpload`,async obj=>{recordedVideoUpload=obj[`${extPrefix}recordedVideoUpload`];if(recordedVideoUpload){uploadVideoServer("manual")}});if(helpers.downloadFormats&&helpers.downloadFormats.videos){let dropdownHTML="";let videosDownloads=helpers.downloadFormats.videos;Object.keys(videosDownloads)?.map((items,ind)=>{let isAbled="abled";if(!videosDownloads[items]){isAbled="disabled"}const downloadType=items;const downloadTypeNAME=downloadType.toUpperCase();dropdownHTML+='<div class="share-row share-link label-download-video label-download-'+downloadType+" "+isAbled+'"><div class="download-col"><span>'+downloadTypeNAME+"</span></div></div>"});jQuery(".download-popup-outer .share-popup-inner").html(dropdownHTML)}jQuery(".video-download-local").unbind("mouseover");jQuery(".video-download-local").on("mouseover",()=>{jQuery(".download-popup-outer").show()});jQuery(".video-download-local").unbind("mouseout");jQuery(".video-download-local").on("mouseout",()=>{let xx=jQuery(".video-download-local:hover").length;if(xx==0){jQuery(".download-popup-outer").hide()}});jQuery(".video-share-local").unbind("click");jQuery(".video-share-local").on("click",()=>{helpers.shareVideoLinkPopup()});jQuery(".label-download-video span").unbind("click");jQuery(".label-download-video span").on("click",elem=>{if(jQuery(elem.currentTarget).parents(".share-row").hasClass("disabled")){jQuery("#quix-update-account-wrapper").show();return}jQuery("#quix-update-account-wrapper").hide();let tx=jQuery(elem.currentTarget).text();tx=tx.toLowerCase();downloadCapturedVideo(tx);jQuery(".download-popup-outer").hide()});jQuery(".video-download-feedback").unbind("click");jQuery(".video-download-feedback").on("click",()=>{helpers.shareFeedbackPopup()});jQuery(".label-share .download-col").unbind("click");jQuery(".label-share .download-col").on("click",()=>{helpers.shareVideoLinkPopup();jQuery(".share-popup-outer").hide()});jQuery(".label-email .download-col").unbind("click");jQuery(".label-email .download-col").on("click",()=>{helpers.shareVideoViaEmailPopup();jQuery(".share-popup-outer").hide()});jQuery(".label-social-media .download-col").unbind("click");jQuery(".label-social-media .download-col").on("click",()=>{helpers.shareViaSocialMedia("video")});jQuery(".video-download-logout span").unbind("click");jQuery(".video-download-logout span").on("click",()=>{helpers.handleQuixyLogOut()});jQuery(".video-download-login span").unbind("click");jQuery(".video-download-login span").on("click",()=>{helpers.handleGoogleLogin()});jQuery(".video-download-login-social span").unbind("click");jQuery(".video-download-login-social span").on("click",()=>{helpers.shareLoginPopup()});jQuery(".video-download-signin .download-screen-button").unbind("click");jQuery(".video-download-signin .download-screen-button").on("click",()=>{helpers.handleGoogleLogin()});jQuery(".upload-to-server").unbind("click");jQuery(".upload-to-server").on("click",()=>{uploadVideoServer("manual")});jQuery(".quix-signin-button").unbind("click");jQuery(".quix-signin-button").on("click",()=>{helpers.handleGoogleLogin();helpers.closeSignInpopup()});jQuery(".quix-signin-button-social").unbind("click");jQuery(".quix-signin-button-social").on("click",()=>{document.querySelector("#quix-signin-wrapper").remove();helpers.shareLoginPopup()});jQuery(".quix-signin-close").unbind("click");jQuery(".quix-signin-close").on("click",()=>{helpers.closeSignInpopup()});jQuery(".quix-update-account-close").unbind("click");jQuery(".quix-update-account-close").on("click",()=>{helpers.closeUpdateAccountInpopup()});jQuery(".label-watermark").unbind("click");jQuery(".label-watermark").on("click",()=>{helpers.applyWatermarkPopup("recorder")});jQuery(".label-url-summary").unbind("click");jQuery(".label-url-summary").on("click",()=>{return;helpers.applyUrlSummaryPopup("recorder")});jQuery(".user-dashboard").unbind("click");jQuery(".user-dashboard").on("click",()=>{helpers.openDashboard("videos")});jQuery(".user-edit-video").unbind("click");jQuery(".user-edit-video").on("click",()=>{uploadEditVideo()});jQuery(".ve-google-drive button").unbind("click");jQuery(".ve-google-drive button").on("click",()=>{uploadVideoSocial("google")});jQuery(".ve-youtube button").unbind("click");jQuery(".ve-youtube button").on("click",()=>{uploadVideoSocial("youtube")})};saveBlobData=blob=>{var request=window.indexedDB.open("sgVideoDataDBFinal",1);request.onupgradeneeded=function(event){var db=event.target.result;var objectStore=db.createObjectStore("sgBlobData",{autoIncrement:true})};request.onsuccess=function(event){var db=event.target.result;var transaction=db.transaction(["sgBlobData"],"readwrite");var objectStore=transaction.objectStore("sgBlobData");var getRequest=objectStore.getAll();var deleteRequest=objectStore.clear();var getRequest=objectStore.getAll();deleteRequest.onsuccess=function(event){var putRequest=objectStore.add(blob);putRequest.onsuccess=function(event){var getRequest=objectStore.getAll()};putRequest.onerror=function(event){console.error("Error saving blob data:",event.target.error)}};deleteRequest.onerror=function(event){console.error("Error deleting existing data:",event.target.error)}}};getBlobData=callback=>{var request=window.indexedDB.open("sgVideoDataDBFinal",1);request.onsuccess=function(event){var db=event.target.result;var transaction=db.transaction(["sgBlobData"],"readonly");var objectStore=transaction.objectStore("sgBlobData");var getRequest=objectStore.getAll();getRequest.onsuccess=function(event){var blobData=event.target.result;callback(blobData)};getRequest.onerror=function(event){console.error("Error deleting existing data:",event.target.error)}}};uploadVideoSocial=type=>{let url="";if(type=="google"){url=helpers.api+"/integration/upload-drive"}else if(type=="youtube"){url=helpers.api+"/integration/upload-youtube"}helpers.handleGoogleCode(type,token=>{let formd=new FormData;formd.append("token",token);formd.append("recording",recordedVideoBlobData);helpers.makeServerRequest("POST","form-data",url,formd,res=>{if(res.status){helpers.successMessagePopup("Uploaded Successfully","Recording is uploaded Successfully.");jQuery("#quix-popup-loader").hide()}else{helpers.failureMessagePopup("Upload Failed","Something Went Wrong.");jQuery("#quix-popup-loader").hide()}})})};uploadVideoServer=async(type="manual")=>{chrome.storage.local.get(`${extPrefix}quixyLoginUserData`,result=>{if(result[`${extPrefix}quixyLoginUserData`]!==""&&result[`${extPrefix}quixyLoginUserData`]!==null){uploadVideoServerHandler(type,result)}else{helpers.openSignInpopup();helpers.setIntervalRef=setInterval(()=>{chrome.storage.local.get(`${extPrefix}quixyLoginUserData`,result=>{if(result[`${extPrefix}quixyLoginUserData`]!==""&&result[`${extPrefix}quixyLoginUserData`]!==null){clearInterval(helpers.setIntervalRef);uploadVideoServerHandler(type,result)}})},500)}})};uploadVideoServerHandler=(type,result)=>{chrome.storage.local.get(`${extPrefix}isVideoUploadedToServer`,res=>{console.log(res[`${extPrefix}isVideoUploadedToServer`],"res[`${extPrefix}isVideoUploadedToServer`]");if(!res[`${extPrefix}isVideoUploadedToServer`]){uploadVideoProcess(type,result)}else{console.log(result,"--");let sessionData=result[`${extPrefix}quixyLoginUserData`];let data={access_token:sessionData?.access_token,user_id:parseInt(sessionData.id),vid:res[`${extPrefix}isVideoUploadedToServer`]?.insertedId};helpers.makeServerRequest("POST","json",helpers.api+"/videos/exist",data,resp=>{if(resp.responseJSON){resp=resp.responseJSON}else{resp=resp}if(!resp.status){uploadVideoProcess(type,result)}else{if(type=="manual"){helpers.failureMessagePopup("Upload Failed","You have already uploaded this file to server.")}if(helpers.setIntervalRef){clearInterval(helpers.setIntervalRef)}}})}})};uploadVideoProcess=(type,result)=>{if(type=="manual"){jQuery(".quix-popup-loader-inner img").attr("src","images/UploadLoader.gif");jQuery(".quix-popup-loader-inner img").css({width:"200px",height:"auto"});jQuery("#quix-popup-loader").show()}let sessionData=result[`${extPrefix}quixyLoginUserData`];uploadVideoServerRequest(sessionData,res=>{if(res.responseJSON){res=res.responseJSON}else{res=res}if(type=="manual"){jQuery("#quix-popup-loader").hide();jQuery(".quix-popup-loader-inner img").attr("src","images/light-loader.gif");jQuery(".quix-popup-loader-inner img").css({width:"65px",height:"auto"})}if(res.status){console.log("response",res);let data={[`${extPrefix}isVideoUploadedToServer`]:res};chrome.storage.local.set(data,()=>{});if(type=="manual"){helpers.successMessagePopup("Uploaded Successfully","Recording is uploaded Successfully.")}}else{if(type=="manual"){if(res.message=="You exceeded Limit."){helpers.failureMessagePopup("Upload Failed","You have reached max upload limit.")}else{helpers.failureMessagePopup("Upload Failed","Something Went Wrong.")}}if(helpers.setIntervalRef){clearInterval(helpers.setIntervalRef)}}})};uploadEditVideo=()=>{chrome.storage.local.get(`${extPrefix}quixyLoginUserData`,result=>{if(result[`${extPrefix}quixyLoginUserData`]!==""&&result[`${extPrefix}quixyLoginUserData`]!==null){uploadEditVideoHandler(result)}else{helpers.openSignInpopup();helpers.setIntervalRef=setInterval(()=>{chrome.storage.local.get(`${extPrefix}quixyLoginUserData`,result=>{if(result[`${extPrefix}quixyLoginUserData`]!==""&&result[`${extPrefix}quixyLoginUserData`]!==null){clearInterval(helpers.setIntervalRef);uploadEditVideoHandler(result)}})},500)}})};uploadEditVideoHandler=result=>{chrome.storage.local.get(`${extPrefix}isVideoUploadedToServer`,res=>{if(!res[`${extPrefix}isVideoUploadedToServer`]){editVideoHandler(result)}else{let sessionData=result[`${extPrefix}quixyLoginUserData`];let data={access_token:sessionData?.access_token,user_id:parseInt(sessionData.id),vid:res[`${extPrefix}isVideoUploadedToServer`]?.insertedId};helpers.makeServerRequest("POST","json",helpers.api+"/videos/exist",data,resp=>{if(resp.responseJSON){resp=resp.responseJSON}else{resp=resp}if(!resp.status){editVideoHandler(result)}else{const url=`${helpers.dashboard}/edit-video/${res[`${extPrefix}isVideoUploadedToServer`].insertedId}`;window.open(url,"_blank")}})}})};editVideoHandler=result=>{jQuery(".quix-popup-loader-inner img").attr("src","images/UploadLoader.gif");jQuery(".quix-popup-loader-inner img").css({width:"200px",height:"auto"});jQuery("#quix-popup-loader").show();let sessionData=result[`${extPrefix}quixyLoginUserData`];uploadVideoServerRequest(sessionData,resp=>{if(resp.responseJSON){resp=resp.responseJSON}else{resp=resp}if(resp.status){let data={[`${extPrefix}isVideoUploadedToServer`]:resp};chrome.storage.local.set(data,()=>{});jQuery("#quix-popup-loader").hide();jQuery(".quix-popup-loader-inner img").attr("src","images/light-loader.gif");jQuery(".quix-popup-loader-inner img").css({width:"65px",height:"auto"});window.open(helpers.dashboard+"/edit-video/"+resp.insertedId,"_blank")}else{jQuery("#quix-popup-loader").hide();jQuery(".quix-popup-loader-inner img").attr("src","images/light-loader.gif");jQuery(".quix-popup-loader-inner img").css({width:"65px",height:"auto"});if(resp.message=="You exceeded Limit."){helpers.failureMessagePopup("Upload Failed","You have reached max upload limit.")}else{helpers.failureMessagePopup("Upload Failed","Something Went Wrong.")}if(helpers.setIntervalRef){clearInterval(helpers.setIntervalRef)}}})};uploadVideoServerRequest=async(sessionData,callback)=>{helpers.addTitleAndSummaryPopup(function(itemTitle,itemSummary,tagIdList){let formd=new FormData;formd.append("name","test.webm");formd.append("user_id",parseInt(sessionData.id));formd.append("access_token",sessionData?.access_token);formd.append("file_size",recordedvideoSize);formd.append("file_duration",null);formd.append("recording",recordedVideoBlobData);formd.append("title",itemTitle);formd.append("summary",itemSummary);formd.append("tags",tagIdList);helpers.makeServerRequest("POST","form-data",helpers.api+"/videos/upload",formd,res=>{callback(res)})})};downloadCapturedVideo=downloadType=>{if(downloadType=="webm"){const link=document.createElement("a");link.href=recordedVideoData;link.download="RecordedVideo";document.body.appendChild(link);link.click();document.body.removeChild(link);helpers.successMessagePopup("Download Complete","Recording is downloaded into downloads.")}else{jQuery("#quix-popup-loader").show();chrome.storage.local.get(`${extPrefix}quixyLoginUserData`,result=>{if(result[`${extPrefix}quixyLoginUserData`]!==""&&result[`${extPrefix}quixyLoginUserData`]!==null){downloadCapturedVideoHandler(downloadType,result)}else{helpers.openSignInpopup();helpers.setIntervalRef=setInterval(()=>{chrome.storage.local.get(`${extPrefix}quixyLoginUserData`,result=>{if(result[`${extPrefix}quixyLoginUserData`]!==""&&result[`${extPrefix}quixyLoginUserData`]!==null){clearInterval(helpers.setIntervalRef);downloadCapturedVideoHandler(downloadType,result)}})},500)}})}};downloadCapturedVideoHandler=(downloadType,result)=>{let sessionData=result[`${extPrefix}quixyLoginUserData`];chrome.storage.local.get(`${extPrefix}isVideoUploadedToServer`,res=>{if(!res[`${extPrefix}isVideoUploadedToServer`]){downloadVideoUploadHandler(result)}else{let data={access_token:sessionData?.access_token,user_id:parseInt(sessionData.id),vid:res[`${extPrefix}isVideoUploadedToServer`]?.insertedId};helpers.makeServerRequest("POST","json",helpers.api+"/videos/exist",data,resp=>{if(resp.responseJSON){resp=resp.responseJSON}else{resp=resp}if(!resp.status){downloadVideoUploadHandler(result)}else{jQuery("#quix-popup-loader").hide();const link=document.createElement("a");link.href=helpers.api+res[`${extPrefix}isVideoUploadedToServer`].path;link.download="RecordedVideo";document.body.appendChild(link);link.click();document.body.removeChild(link);helpers.successMessagePopup("Download Complete","Recording is downloaded into downloads.");if(helpers.setIntervalRef){clearInterval(helpers.setIntervalRef)}}})}})};downloadVideoUploadHandler=result=>{let sessionData=result[`${extPrefix}quixyLoginUserData`];helpers.addTitleAndSummaryPopup(function(itemTitle,itemSummary,tagIdList){let formd=new FormData;formd.append("name","test.webm");formd.append("user_id",parseInt(sessionData.id));formd.append("access_token",sessionData?.access_token);formd.append("file_size",recordedvideoSize);formd.append("file_duration",null);formd.append("recording",recordedVideoBlobData);formd.append("title",itemTitle);formd.append("summary",itemSummary);formd.append("tags",tagIdList);helpers.makeServerRequest("POST","form-data",helpers.api+"/videos/upload",formd,res=>{if(res.status){let data1={[`${extPrefix}isVideoUploadedToServer`]:res};chrome.storage.local.set(data1,()=>{});jQuery("#quix-popup-loader").hide();const link=document.createElement("a");link.href=helpers.api+res.path;link.download="RecordedVideo";document.body.appendChild(link);link.click();document.body.removeChild(link);helpers.successMessagePopup("Download Complete","Recording is downloaded into downloads.")}else{jQuery("#quix-popup-loader").hide();if(helpers.setIntervalRef){clearInterval(helpers.setIntervalRef)}if(res.message=="You exceeded Limit."){helpers.failureMessagePopup("Upload Failed","You have reached max upload limit.")}else{helpers.failureMessagePopup("Upload Failed","Something Went Wrong.")}}})})};