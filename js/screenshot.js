let start={};let end={};let isSelecting=false;let winH=0;let wScrolled=0;let docHeight=0;let baseImgArr=[];let imagesposY=0;let lastScreenshotH=0;let fullScreenShotCan="";let fullScreenShotContext="";let rect={};let rectB={};let rectH={};let rectS={};let ctx="";let ctxB="";let ctxH="";let ctxS="";let imageObjB=null;let imageObjS=null;let imageObjH=null;let canBGMain=null;let canvasMain=null;let drag="";let screenPriorToBlur="";let screenPriorToHighlight="";let screenPriorToShape="";let screenPriorToUpload="";let screenShotType="Visible Part Screenshot";let originalImage="";let screenshotName="";let updateScreenshot="";let canvas_background=null;let screensHistoryData=[];let screensHistoryStep=0;let canvasScale=1;let zoomValueX=0;let zoomValueY=0;let zoomValuePercent=100;let zoomValuePercentRatio=1;let cooridnatesDrawnAt=[];let isScreenshotUpdated=false;let screenshotUploadServer=false;let loaderIcon="";let feedbackIcon="";let successIcon="";let failureIcon="";let checkSvgItemAddedOrRemoved=false;let svgItemsCount=0;let checkAnnoPositionChanged=false;let uploadScreenShotCount=0;let editScreenshot;let extPrefix="SG_";window.onbeforeunload=function(){return"Do you really want to exit? Your progress will be lost."};window.addEventListener("focus",function(event){if(jQuery(".download-mode").css("display")=="block"){chrome.storage.local.get(`${extPrefix}quixyLoginUserData`,function(result){if(result[`${extPrefix}quixyLoginUserData`]!=""&&result[`${extPrefix}quixyLoginUserData`]!=null){const data=JSON.stringify({access_token:result[`${extPrefix}quixyLoginUserData`].access_token,token_type:"extension"});helpers.makeServerRequest("POST","",helpers.api+"/user/get",data,function(res){helpers.handleUserSession(res,"get")})}else{helpers.handleUserSession({})}})}});window.onload=function(){editScreenshot=new editScreenshotSG;helpers=new helperSG;chrome.storage.local.get(`${extPrefix}quixyLoginUserData`,function(result){if(result[`${extPrefix}quixyLoginUserData`]!=""&&result[`${extPrefix}quixyLoginUserData`]!=null){const data=JSON.stringify({access_token:result[`${extPrefix}quixyLoginUserData`].access_token,token_type:"extension"});helpers.makeServerRequest("POST","",helpers.api+"/user/get",data,function(res){helpers.handleUserSession(res,"get")})}else{helpers.handleUserSession({})}});chrome.storage.local.get(`${extPrefix}quixyScreenshotFinal`,async function(obj){if(obj[`${extPrefix}quixyScreenshotFinal`]!==undefined&&obj[`${extPrefix}quixyScreenshotFinal`]!==""){editScreenshot.screensHistory(obj[`${extPrefix}quixyScreenshotFinal`],1);editScreenshot.loadScreenshotOnCanvas(obj[`${extPrefix}quixyScreenshotFinal`]);addListenersToPage();editScreenshot.addEventListeners()}else{chrome.storage.local.get(`${extPrefix}quixyScreenshot`,async function(obj){if(obj[`${extPrefix}quixyScreenshot`]!==undefined&&obj[`${extPrefix}quixyScreenshot`]!==""){loadEditableScreenshotOnCanvas(obj[`${extPrefix}quixyScreenshot`])}else{jQuery("#upload-custom-screenshot-outer").css({display:"table"})}})}});chrome.storage.local.get(`${extPrefix}originalImage`,async function(obj){if(obj[`${extPrefix}originalImage`]!==undefined&&obj[`${extPrefix}originalImage`]!==""){originalImage=obj[`${extPrefix}originalImage`]}});chrome.storage.local.get(`${extPrefix}screenshotName`,async function(obj){if(obj[`${extPrefix}screenshotName`]!==undefined&&obj[`${extPrefix}screenshotName`]!==""){screenshotName=obj[`${extPrefix}screenshotName`]}});chrome.storage.local.get(`${extPrefix}cooridnatesDrawnAt`,async function(obj){if(obj[`${extPrefix}cooridnatesDrawnAt`]!==undefined&&obj[`${extPrefix}cooridnatesDrawnAt`]!==""){cooridnatesDrawnAt=obj[`${extPrefix}cooridnatesDrawnAt`]}});chrome.storage.local.get(`${extPrefix}isScreenshotUploadedToServer`,async function(obj){if(obj[`${extPrefix}isScreenshotUploadedToServer`]!==undefined&&obj[`${extPrefix}isScreenshotUploadedToServer`]!==""){if(obj[`${extPrefix}isScreenshotUploadedToServer`]){uploadScreenShotCount++;isScreenshotUpdated=false;editScreenshot.needUploadScreanshotToServer=false}else{editScreenshot.needUploadScreanshotToServer=true}}});chrome.storage.local.get(`${extPrefix}quixyScreenShotType`,async function(obj){if(obj[`${extPrefix}quixyScreenShotType`]!==undefined&&obj[`${extPrefix}quixyScreenShotType`]!==""){jQuery("#screenshot-wrapper-top-left span").text(obj[`${extPrefix}quixyScreenShotType`])}})};document.onpaste=function(event){var items=(event.clipboardData||event.originalEvent.clipboardData).items;for(index in items){var item=items[index];if(item.kind==="file"&&item.type.indexOf("image/")>-1){var blob=item.getAsFile();editScreenshot.uploadAnnotationRequest(blob)}}};jQuery(".close-download-full").unbind("click");jQuery(".close-download-full").on("click",function(){let text="Are you sure you want to leave?";if(confirm(text)==true){editScreenshot.clearFinalScreenshot();window.close()}});jQuery("#upload-custom-screenshot").unbind("change");jQuery("#upload-custom-screenshot").on("change",function(event){const validTypes=["image/jpeg","image/png","image/jpg","image/svg"];if(!validTypes.includes(event.target.files[0].type)){helpers.failureMessagePopup("Invalid Format","Only PNG, JPG, JPEG files allowed.");return}const reader=new FileReader;reader.readAsDataURL(event.target.files[0]);reader.onload=function(){let dataURI=reader.result;loadEditableScreenshotOnCanvas(dataURI);let data={[`${extPrefix}quixyScreenshot`]:dataURI};chrome.storage.local.set(data,function(){});jQuery("#upload-custom-screenshot-outer").hide()};reader.onerror=function(error){console.log(error)}});document.querySelector("#blur-strength").addEventListener("change",e=>{let value=e.target.value;jQuery(e.currentTarget).attr("value",value);document.getElementById("range-value-blur-strength").textContent=value});function loadEditableScreenshotOnCanvas(screenshot,callback){let image=new Image;image.onload=function(){setScreenshotName();editScreenshot.addPaddingArea(image,function(){let canvas=document.getElementById("captured-screen");let sshot=canvas.toDataURL("image/jpeg",1);originalImage=sshot;editScreenshot.firstScreenShot=sshot;chrome.runtime.sendMessage({type:"updateCordinates",cooridnatesDrawnAt:editScreenshot.svgCordinates});chrome.runtime.sendMessage({type:"quixyFinalScreenshot",screen:sshot});let data2={[`${extPrefix}originalImage`]:sshot};chrome.storage.local.set(data2,function(){});editScreenshot.autoadjustScreenshot(canvas.width,canvas.height);editScreenshot.screensHistory(sshot);addListenersToPage();editScreenshot.addEventListeners()})};image.src=screenshot}const addcreenshotWhiteArea=()=>{let canvas=document.getElementById("captured-screen");let imageURI=canvas.toDataURL("image/jpeg",1);let image=new Image;image.onload=function(){editScreenshot.addPaddingArea(image,function(){let canvas=document.getElementById("captured-screen");let sshot=canvas.toDataURL("image/jpeg",1);originalImage=sshot;chrome.runtime.sendMessage({type:"updateCordinates",cooridnatesDrawnAt:cooridnatesDrawnAt});chrome.runtime.sendMessage({type:"quixyFinalScreenshot",screen:sshot});let data2={[`${extPrefix}originalImage`]:sshot};chrome.storage.local.set(data2,function(){});editScreenshot.autoadjustScreenshot(canvas.width,canvas.height);editScreenshot.screensHistory(sshot);addListenersToPage();editScreenshot.addEventListeners()})};image.src=imageURI};const removeScreenshotWhiteArea=()=>{let canvas=document.getElementById("captured-screen");let imageURI=canvas.toDataURL("image/jpeg",1);let image=new Image;image.onload=function(){editScreenshot.removePaddingArea(image,function(){let canvas=document.getElementById("captured-screen");let sshot=canvas.toDataURL("image/jpeg",1);originalImage=sshot;chrome.runtime.sendMessage({type:"updateCordinates",cooridnatesDrawnAt:cooridnatesDrawnAt});chrome.runtime.sendMessage({type:"quixyFinalScreenshot",screen:sshot});let data2={[`${extPrefix}originalImage`]:sshot};chrome.storage.local.set(data2,function(){});editScreenshot.autoadjustScreenshot(canvas.width,canvas.height);editScreenshot.screensHistory(sshot);addListenersToPage();editScreenshot.addEventListeners()})};image.src=imageURI};const addListenersToPage=()=>{jQuery(".download-mode #screenshot-wrapper-top").unbind("click");jQuery(".download-mode #screenshot-wrapper-top").on("click",()=>{if(helpers.setIntervalRef){clearInterval(helpers.setIntervalRef)}});jQuery(".icon-undo img").unbind("click");jQuery(".icon-undo img").on("click",()=>{editScreenshot.removeIconActiveState(".annotate-ul .sideBar-li");jQuery("#annotations-popup-outer").hide();editScreenshot.SvgperformUndoRedo("undo")});jQuery(".icon-redo img").unbind("click");jQuery(".icon-redo img").on("click",()=>{editScreenshot.removeIconActiveState(".annotate-ul .sideBar-li");jQuery("#annotations-popup-outer").hide();editScreenshot.SvgperformUndoRedo("redo")});jQuery(".zoom-quix-in").unbind("click");jQuery(".zoom-quix-in").on("click",()=>{editScreenshot.quixyZoomIn()});jQuery(".zoom-quix-out").unbind("click");jQuery(".zoom-quix-out").on("click",()=>{editScreenshot.quixyZoomOut()});jQuery(".fulscreen-mode .label-reset").unbind("click");jQuery(".fulscreen-mode .label-reset").on("click",()=>{editScreenshot.resetOriginalImage()});jQuery(".download-mode .label-reset").unbind("click");jQuery(".download-mode .label-reset").on("click",()=>{if(document.querySelector("#quix-padding-annotation-fields-download")){document.querySelector("#quix-padding-annotation-fields-download").style.display="none"}if(document.querySelector("#quix-crop-annotation-fields-download")){document.querySelector("#quix-crop-annotation-fields-download").style.display="none"}editScreenshot.resetOriginalImageDownload()});jQuery(".copy-clipboard").unbind("click");jQuery(".copy-clipboard").on("click",()=>{editScreenshot.copyClipboard()});jQuery(".label-email .download-col").unbind("click");jQuery(".label-email .download-col").on("click",()=>{helpers.shareViaEmail()});jQuery(".label-social-media .download-col").unbind("click");jQuery(".label-social-media .download-col").on("click",()=>{helpers.shareViaSocialMedia("screenshot")});jQuery(".label-share .download-col").unbind("click");jQuery(".label-share .download-col").on("click",()=>{editScreenshot.removeCropDownloadAnnotation();editScreenshot.removePaddingBorderAnnotationToolbar();if(editScreenshot.needUploadScreanshotToServer==true){isScreenshotUpdated=true;let data7={[`${extPrefix}isScreenshotUploadedToServer`]:false};chrome.storage.local.set(data7,()=>{});editScreenshot.needUploadScreanshotToServer=false}helpers.shareLinkPopup();jQuery(".share-popup-outer").hide()});jQuery(".sideBar-li").unbind("mouseover");jQuery(".sideBar-li").on("mouseover",elem=>{editScreenshot.iconMouseOver(jQuery(elem.currentTarget))});jQuery(".sideBar-li").unbind("mouseout");jQuery(".sideBar-li").on("mouseout",elem=>{editScreenshot.iconMouseOut(jQuery(elem.currentTarget))});jQuery(".input-radio-custom").unbind("mouseover");jQuery(".input-radio-custom").on("mouseover",elem=>{editScreenshot.iconMouseOver(jQuery(elem.currentTarget))});jQuery(".input-radio-custom").unbind("mouseout");jQuery(".input-radio-custom").on("mouseout",elem=>{editScreenshot.iconMouseOut(jQuery(elem.currentTarget))});jQuery(".input-radio-custom-align").unbind("click");jQuery(".input-radio-custom-align").on("click",elem=>{editScreenshot.iconMouseClick(jQuery(elem.currentTarget),".input-radio-custom-align")});jQuery(".input-radio-custom-style").unbind("click");jQuery(".input-radio-custom-style").on("click",()=>{editScreenshot.iconMouseToggle(this,".input-radio-custom-style")});jQuery(".screenshot-close-inner img").unbind("click");jQuery(".screenshot-close-inner img").on("click",()=>{let text="Are you sure you want to leave?";if(confirm(text)==true){jQuery("body").css({overflow:"auto"});jQuery("#download-overlay").remove();jQuery(".download-screenshot-half").unbind("click");jQuery(".download-screenshot-full").unbind("click");jQuery(".screenshot-close-inner img").unbind("click")}});jQuery(".selected-download-option").unbind("mouseover");jQuery(".selected-download-option").on("mouseover",()=>{jQuery(".selected-download-list").show()});jQuery(".download-screenshot-half").unbind("mouseout");jQuery(".download-screenshot-half").on("mouseout",()=>{let xx=jQuery(".download-screenshot-half:hover").length;if(xx==0){jQuery(".selected-download-list").hide()}});jQuery(".quix-shapes").unbind("mouseover");jQuery(".quix-shapes").on("mouseover",()=>{jQuery(".shapes-popup-outer").show()});jQuery(".quix-library").unbind("mouseover");jQuery(".quix-library").on("mouseover",()=>{jQuery(".library-popup-outer").show()});jQuery(".quix-others").unbind("mouseover");jQuery(".quix-others").on("mouseover",()=>{jQuery(".others-popup-outer").show()});jQuery(".label-download").unbind("mouseover");jQuery(".label-download").on("mouseover",()=>{jQuery(".download-popup-outer").show()});jQuery(".icon-shareable").unbind("click");jQuery(".icon-shareable").on("click",()=>{editScreenshot.removeCropDownloadAnnotation();editScreenshot.removePaddingBorderAnnotationToolbar();if(editScreenshot.needUploadScreanshotToServer==true){isScreenshotUpdated=true;let data7={[`${extPrefix}isScreenshotUploadedToServer`]:false};chrome.storage.local.set(data7,()=>{});editScreenshot.needUploadScreanshotToServer=false}helpers.shareLinkPopup()});jQuery(".quix-shapes").unbind("mouseout");jQuery(".quix-shapes").on("mouseout",()=>{let xx=jQuery(".quix-shapes:hover").length;if(xx==0){jQuery(".shapes-popup-outer").hide()}});jQuery(".quix-library").unbind("mouseout");jQuery(".quix-library").on("mouseout",()=>{let xx=jQuery(".quix-library:hover").length;if(xx==0){jQuery(".library-popup-outer").hide()}});jQuery(".quix-others").unbind("mouseout");jQuery(".quix-others").on("mouseout",()=>{let xx=jQuery(".quix-others:hover").length;if(xx==0){jQuery(".others-popup-outer").hide()}});jQuery(".label-download").unbind("mouseout");jQuery(".label-download").on("mouseout",()=>{let xx=jQuery(".label-download:hover").length;if(xx==0){jQuery(".download-popup-outer").hide()}});jQuery(".label-watermark").unbind("click");jQuery(".label-watermark").on("click",()=>{helpers.applyWatermarkPopup("screenshot")});jQuery(".label-url-summary").unbind("click");jQuery(".label-url-summary").on("click",()=>{return;helpers.applyUrlSummaryPopup("screenshot")});jQuery(".download-screenshot-full").unbind("mouseout");jQuery(".download-screenshot-full").on("mouseout",()=>{let xx=jQuery(".download-screenshot-full:hover").length;if(xx==0){jQuery(".selected-download-list").hide()}});jQuery(".screenshot-title input").unbind("keyup");jQuery(".screenshot-title input").on("keyup",elem=>{screenshotName=jQuery(elem.currentTarget).val();screenshotName=screenshotName.replace(/\s/g,"");jQuery(elem.currentTarget).val(screenshotName);let data={[`${extPrefix}screenshotName`]:screenshotName};chrome.storage.local.set(data)});jQuery(".screenshot-maximize-inner img").unbind("click");jQuery(".screenshot-maximize-inner img").on("click",()=>{let canvas=document.getElementById("captured-screen");let capturedScreen=canvas.toDataURL("image/jpeg",1);chrome.runtime.sendMessage({type:"openNewTab",screen:capturedScreen,originalImage:originalImage,screenshotName:screenshotName})});jQuery("#screenshot-wrapper-bottom").unbind("mouseout");jQuery("#screenshot-wrapper-bottom").on("mouseout",()=>{jQuery("body").on("mouseup",()=>{if(editScreenshot.drag){editScreenshot.mouseUp()}})});setUiDimensions();window.addEventListener("resize",function(event){setUiDimensions("resize")},true);jQuery("#share-via-copy img").unbind("click");jQuery("#share-via-copy img").on("click",()=>{editScreenshot.copyClipboard()});jQuery("#done-editing").unbind("click");jQuery("#done-editing").on("click",()=>{try{jQuery("#done-editing").css("pointer-events","none");const data=editScreenshot.whereAnnoDrawArray.map(data=>data);if(data.length>=2){const lastData=data[data.length-1];const secondLastData=data[data.length-2];const isChanged=JSON.stringify(lastData)!==JSON.stringify(secondLastData);if(isChanged){checkAnnoPositionChanged=true}else{checkAnnoPositionChanged=false}}else{checkAnnoPositionChanged=false}if((checkAnnoPositionChanged==true||editScreenshot.svgCordinates.length!=svgItemsCount)&&uploadScreenShotCount>=1){editScreenshot.needUploadScreanshotToServer=true}else{editScreenshot.needUploadScreanshotToServer=false}svgItemsCount=editScreenshot.svgCordinates.length;editScreenshot.openPaddingPopup()}catch(error){jQuery("#done-editing").css("pointer-events","all");console.log("err",error.message)}});jQuery("#page-back").unbind("click");jQuery("#page-back").on("click",()=>{jQuery("#done-editing").css("pointer-events","all");editScreenshot.removeCropDownloadAnnotation();editScreenshot.removePaddingBorderAnnotationToolbar("reset");document.querySelector("div#download-overlay.download-mode").style.display="none";document.querySelector("div#download-overlay.fulscreen-mode").style.display="block";editScreenshot.loadScreenshotOnCanvas(editScreenshot.firstScreenShotAddedWaterMark,undefined,"back");setUiDimensions()})};fitDownloadCanvasToSsreen=()=>{let canvas=document.getElementById("padding-screen");let downloadScreenCanvas=document.querySelector("#screenshot-area-left #download-screen-canvas");let areaLeft=document.querySelector("#screenshot-area-left");let checkLeftAreaDimensions=setInterval(function(){let areaLeftW=areaLeft.offsetWidth;let areaLeftH=areaLeft.offsetHeight;if(areaLeftW>30){if(canvas.width<areaLeftW){downloadScreenCanvas.style.cssText="height:auto; width:"+canvas.width+"px"+";";editScreenshot.downloadScreenWidth=downloadScreenCanvas.style.width;editScreenshot.downloadScreenHeight=downloadScreenCanvas.style.height;editScreenshot.downloadScreenWidthZero=downloadScreenCanvas.style.width;editScreenshot.downloadScreenHeightZero=downloadScreenCanvas.style.height}else{downloadScreenCanvas.style.cssText="height:auto; width:"+(areaLeftW-30)+"px"+";";editScreenshot.downloadScreenWidth=downloadScreenCanvas.style.width;editScreenshot.downloadScreenHeight=downloadScreenCanvas.style.height;editScreenshot.downloadScreenWidthZero=downloadScreenCanvas.style.width;editScreenshot.downloadScreenHeightZero=downloadScreenCanvas.style.height}clearInterval(checkLeftAreaDimensions)}},200)};loadScreenshotOnDownloadScreen=mode=>{let mainCanvas=document.getElementById("captured-screen");let canvas=document.getElementById("captured-screen");if(mode=="continue"){canvas=document.getElementById("padding-screen")}let source=canvas.toDataURL("image/jpeg",1);let downloadScreenCanvas=document.querySelector("#screenshot-area-left #download-screen-canvas");let context=downloadScreenCanvas.getContext("2d");editScreenshot.ctxD=downloadScreenCanvas.getContext("2d");downloadScreenCanvas.width=canvas.width;downloadScreenCanvas.height=canvas.height;fitDownloadCanvasToSsreen();let image=new Image;image.onload=()=>{context.drawImage(image,0,0);editScreenshot.downloadScreenImgZero=image;editScreenshot.downloadScreenImg0=image;editScreenshot.downloadScreenImg=image;editScreenshot.downloadScreenImg1=image;editScreenshot.downloadScreenImgflip=image};image.src=source;jQuery(".screenshot-title input").val(screenshotName);setUiDimensionsDownloadScreen();setTimeout(function(){addEventListenersDownloadsScreen()},100)};addEventListenersDownloadsScreen=()=>{if(helpers.downloadFormats&&helpers.downloadFormats.screenshots){let dropdownHTML="";let screenshotDownloads=helpers.downloadFormats.screenshots;Object.keys(screenshotDownloads)?.map((items,ind)=>{let isAbled="abled";if(!screenshotDownloads[items]){isAbled="disabled"}const downloadType=items;const downloadTypeNAME=downloadType.toUpperCase();dropdownHTML+='<div class="download-row download-'+downloadType+" "+isAbled+'"><div class="download-col"><span>'+downloadTypeNAME+"</span></div></div>"});jQuery(".download-popup-inner").html(dropdownHTML);jQuery(".download-col span").unbind("click");jQuery(".download-col span").on("click",elem=>{if(jQuery(elem.currentTarget).parents(".download-row").hasClass("disabled")){jQuery("#quix-update-account-wrapper").show();return}jQuery("#quix-update-account-wrapper").hide();let tx=jQuery(elem.currentTarget).text();downloadScreenshot(tx);jQuery(".download-popup-outer").hide()})}document.querySelector(".download-mode #screenshot-wrapper-top").addEventListener("click",function(event){if(event.target=="span"||event.target=="img"){if(event.target.closest("#screenshot-wrapper-top")){editScreenshot.removeCropDownloadAnnotation();editScreenshot.removePaddingBorderAnnotationToolbar()}}});jQuery("#download-as-print").unbind("click");jQuery("#download-as-print").on("click",()=>{let imgSrc="http://i.stack.imgur.com/hCYTd.jpg";let win=window.open(imgSrc,"_blank");win.onload=()=>{win.print()}});jQuery("#share-via-copy img").unbind("click");jQuery("#share-via-copy img").on("click",()=>{editScreenshot.removeCropDownloadAnnotation();editScreenshot.removePaddingBorderAnnotationToolbar();editScreenshot.copyClipboard()});jQuery("#share-feedback").unbind("click");jQuery("#share-feedback").on("click",()=>{editScreenshot.removeCropDownloadAnnotation();editScreenshot.removePaddingBorderAnnotationToolbar();helpers.shareFeedbackPopup()});jQuery(".quix-upload .user-logIn").unbind("click");jQuery(".quix-upload .user-logIn").on("click",()=>{editScreenshot.removeCropDownloadAnnotation();editScreenshot.removePaddingBorderAnnotationToolbar();helpers.handleGoogleLogin()});jQuery(".quix-upload .user-logIn-social").unbind("click");jQuery(".quix-upload .user-logIn-social").on("click",()=>{editScreenshot.removeCropDownloadAnnotation();editScreenshot.removePaddingBorderAnnotationToolbar();helpers.shareLoginPopup()});jQuery(".quix-upload .user-upload").unbind("click");jQuery(".quix-upload .user-upload").on("click",()=>{editScreenshot.removeCropDownloadAnnotation();editScreenshot.removePaddingBorderAnnotationToolbar();if(editScreenshot.needUploadScreanshotToServer){isScreenshotUpdated=true;let data7={[`${extPrefix}isScreenshotUploadedToServer`]:false};chrome.storage.local.set(data7,()=>{});uploadScreenshotServer("manual");editScreenshot.needUploadScreanshotToServer=false}else{uploadScreenshotServer("manual")}});jQuery(".quix-upload .user-logOut").unbind("click");jQuery(".quix-upload .user-logOut").on("click",()=>{editScreenshot.removeCropDownloadAnnotation();editScreenshot.removePaddingBorderAnnotationToolbar();helpers.handleQuixyLogOut()});jQuery(".screenshot-title input").unbind("keyup");jQuery(".screenshot-title input").on("keyup",elem=>{screenshotName=jQuery(elem.currentTarget).val();screenshotName=screenshotName.replace(/\s/g,"");jQuery(elem.currentTarget).val(screenshotName);let data={[`${extPrefix}screenshotName`]:screenshotName};chrome.storage.local.set(data)});jQuery(".quix-signin-button").unbind("click");jQuery(".quix-signin-button").on("click",()=>{helpers.handleGoogleLogin();helpers.closeSignInpopup()});jQuery(".quix-update-account-close").unbind("click");jQuery(".quix-update-account-close").on("click",()=>{helpers.closeUpdateAccountInpopup()});jQuery(".quix-signin-button-social").unbind("click");jQuery(".quix-signin-button-social").on("click",()=>{if(document.querySelector("#quix-signin-wrapper")){document.querySelector("#quix-signin-wrapper").style.display="none"}helpers.shareLoginPopup()});jQuery(".quix-signin-close").unbind("click");jQuery(".quix-signin-close").on("click",()=>{helpers.closeSignInpopup()});jQuery(".user-dashboard").unbind("click");jQuery(".user-dashboard").on("click",()=>{editScreenshot.removeCropDownloadAnnotation();editScreenshot.removePaddingBorderAnnotationToolbar();helpers.openDashboard("screenshots")})};setUiDimensionsDownloadScreen=type=>{let screenW=jQuery("#download-overlay-inner").innerWidth();if(type&&type==="resizeInDownloadPage")screenW=jQuery(".download-mode #download-overlay-inner").innerWidth();let screenH=jQuery(window).height();let topH=jQuery("#screenshot-wrapper-top").outerHeight();let bottomH=jQuery("#screenshot-wrapper-bottom-copyright").outerHeight();let remainH=screenH-(topH+bottomH);if(extPrefix==="OCR_"){jQuery("#screenshot-area-left").css({width:screenW-290+"px",height:remainH-30+"px"})}else{jQuery("#screenshot-area-left").css({width:screenW-30+"px",height:remainH-30+"px"})}};setUiDimensions=type=>{const displayVal=document.querySelector("#download-overlay.fulscreen-mode").style.display;const displayVal2=document.querySelector("#download-overlay.download-mode").style.display;if(displayVal!=="none"){let screenW=jQuery("#download-overlay-inner").innerWidth();let screenH=jQuery(window).height();let topH=jQuery("#screenshot-wrapper-top").outerHeight();let bottomH=jQuery("#screenshot-wrapper-bottom-copyright").outerHeight();let remainH=screenH-(topH+bottomH);if(extPrefix==="OCR_"){jQuery("#screenshot-wrapper-bottom").css({width:screenW-275+"px",height:remainH+"px"})}else{jQuery("#screenshot-wrapper-bottom").css({width:screenW+"px",height:remainH+"px"})}if(type!==undefined&&type==="resize"){let capturedScreen=document.getElementById("captured-screen");let imageURI=capturedScreen.toDataURL("image/jpeg",1);editScreenshot.loadScreenshotOnCanvas(imageURI)}}else if(displayVal2!=="none"){setUiDimensionsDownloadScreen("resizeInDownloadPage")}};downloadScreenshot=selectedMethod=>{editScreenshot.isPreviousAnnDone(()=>{editScreenshot.removeIconActiveState(".annotate-ul .sideBar-li");jQuery("#annotations-popup-outer").hide();let canvas=document.getElementById("padding-screen");srcdata=editScreenshot.downloadScreenImg.src;if(selectedMethod!="DOWNLOAD"){if(selectedMethod=="JPG"||selectedMethod=="PNG"){if(srcdata){let fileName;if(screenshotName&&screenshotName.trim()!==""){if(selectedMethod==="JPG"){fileName=screenshotName.trim()+".jpg"}else{fileName=screenshotName.trim()+".png"}}else{if(selectedMethod==="JPG"){fileName="Untitled.jpg"}else{fileName="Untitled.png"}}let el=document.createElement("a");el.setAttribute("href",srcdata);el.setAttribute("download",fileName);document.body.appendChild(el);try{el.click()}catch(err){alert(err+"Please try to download in full screen mode as host page is retricting the pdf download.")}el.remove()}}else if(selectedMethod=="PDF"){if(srcdata){let srcdataOBJ=srcdata.split(",");let base64EncodedPDF=srcdataOBJ[1];let decodedPdfContent=atob(base64EncodedPDF);let byteArray=new Uint8Array(decodedPdfContent.length);for(let i=0;i<decodedPdfContent.length;i++){byteArray[i]=decodedPdfContent.charCodeAt(i)}let blob=new Blob([byteArray.buffer],{type:"image/jpeg"});srcdata=URL.createObjectURL(blob);getImageFromUrl(srcdata,createPDF)}}}})};getImageFromUrl=(url,callback)=>{let img=new Image;img.onError=()=>{alert('Cannot load image: "'+url+'"')};img.onload=()=>{callback(img)};img.src=url};createPDF=imgData=>{let doc=new jsPDF;let ww=imgData.width;let hh=imgData.height;let ar=ww/hh;let pdfW=parseInt(doc.internal.pageSize.width-20);let pdfH=parseInt(pdfW/ar);let position=0;let heightLeft=pdfH;let pageHeight=parseInt(doc.internal.pageSize.height);doc.addImage(imgData,"JPEG",10,position,pdfW,pdfH);heightLeft-=pageHeight;while(heightLeft>=0){position+=pageHeight;doc.addPage();doc.addImage(imgData,"JPEG",10,-Math.abs(position),pdfW,pdfH);heightLeft-=pageHeight}let fileName;if(screenshotName&&screenshotName.trim()!==""){fileName=screenshotName+".pdf"}else{fileName="Untitled.pdf"}let source=doc.output("datauristring");let el=document.createElement("a");el.setAttribute("href",source);el.setAttribute("download",fileName);document.body.appendChild(el);try{el.click()}catch(err){alert(err+"Please try to download in full screen mode as host page is retricting the pdf download.")}el.remove()};uploadScreenshotServer=async(type="manual",callback)=>{chrome.storage.local.get(`${extPrefix}quixyLoginUserData`,result=>{if(result[`${extPrefix}quixyLoginUserData`]!==""&&result[`${extPrefix}quixyLoginUserData`]!==null){uploadScreenShotServerHandler(type,callback,result)}else{helpers.openSignInpopup();helpers.setIntervalRef=setInterval(()=>{chrome.storage.local.get(`${extPrefix}quixyLoginUserData`,result=>{if(result[`${extPrefix}quixyLoginUserData`]!==""&&result[`${extPrefix}quixyLoginUserData`]!==null){clearInterval(helpers.setIntervalRef);uploadScreenShotServerHandler(type,callback,result)}})},500)}})};uploadScreenshotServerPadding=async(type="manual",source,callback)=>{chrome.storage.local.get(`${extPrefix}quixyLoginUserData`,result=>{if(result[`${extPrefix}quixyLoginUserData`]!==""&&result[`${extPrefix}quixyLoginUserData`]!==null){chrome.storage.local.get(`${extPrefix}isScreenshotUploadedToServer`,async obj=>{if(obj[`${extPrefix}isScreenshotUploadedToServer`]!==undefined&&obj[`${extPrefix}isScreenshotUploadedToServer`]!==""){let isScreenshotUploadedToServer=obj[`${extPrefix}isScreenshotUploadedToServer`];if(!isScreenshotUploadedToServer){if(type=="manual"){jQuery("#quix-popup-loader").show()}let sessionData=result[`${extPrefix}quixyLoginUserData`];let imgS=helpers.getImageSize(source);helpers.dataURItoBlob(source,res=>{helpers.addTitleAndSummaryPopup(function(itemTitle,itemSummary,tagIdList){if(!screenshotName.trim()){screenshotName="untitled-"+Math.floor(1e4+Math.random()*9999)}let fd=new FormData;fd.append("name",screenshotName+".jpg");fd.append("user_id",parseInt(sessionData.id));fd.append("access_token",result[`${extPrefix}quixyLoginUserData`]?.access_token);fd.append("file_size",imgS);fd.append("screenshot",res);fd.append("title",itemTitle);fd.append("summary",itemTitle);fd.append("tags",tagIdList);helpers.makeServerRequest("POST","form-data",helpers.api+"/screenshots/upload",fd,res=>{if(type=="manual"){jQuery("#quix-popup-loader").hide()}if(res.responseJSON){res=res.responseJSON}else{res=res}if(res.status){if(callback!==undefined){callback(res)}uploadScreenShotCount++;isScreenshotUpdated=false;editScreenshot.needUploadScreanshotToServer=false;let data={[`${extPrefix}isScreenshotUploadedToServer`]:res.insertedId};chrome.storage.local.set(data,()=>{});if(type=="manual"){helpers.successMessagePopup("Uploaded Successfully","Screenshot is uploaded Successfully.")}}else{if(res.message=="You exceeded Limit."){jQuery("#email-share-popup-wrapper").remove();jQuery("#link-share-popup-wrapper").remove();helpers.failureMessagePopup("Upload Failed","You have reached max upload limit.")}else{jQuery("#email-share-popup-wrapper").remove();jQuery("#link-share-popup-wrapper").remove();helpers.failureMessagePopup("Upload Failed","Something Went Wrong.")}}})})})}else{if(type=="manual"){jQuery("#email-share-popup-wrapper").remove();jQuery("#link-share-popup-wrapper").remove();helpers.failureMessagePopup("Upload Failed","You have already uploaded this file to server.")}}}})}else{helpers.openSignInpopup()}})};setScreenshotName=()=>{screenshotName="IMG_"+Math.floor(Math.random()*1e4);let data={[`${extPrefix}screenshotName`]:screenshotName};chrome.storage.local.set(data);jQuery(".screenshot-title input").val(screenshotName)};uploadScreenShotServerHandler=(type,callback,result)=>{chrome.storage.local.get(`${extPrefix}isScreenshotUploadedToServer`,async obj=>{if(obj[`${extPrefix}isScreenshotUploadedToServer`]!==undefined&&obj[`${extPrefix}isScreenshotUploadedToServer`]!==""){let isScreenshotUploadedToServer=obj[`${extPrefix}isScreenshotUploadedToServer`];let sessionData=result[`${extPrefix}quixyLoginUserData`];let data={access_token:result[`${extPrefix}quixyLoginUserData`]?.access_token,user_id:parseInt(sessionData.id),sid:isScreenshotUploadedToServer};if(isScreenshotUploadedToServer){helpers.makeServerRequest("POST","json",helpers.api+"/screenshots/exist",data,resp=>{if(resp.responseJSON){resp=resp.responseJSON}else{resp=resp}if(!resp.status){uploadFunction(type,callback,result)}else{if(type=="manual"){jQuery("#email-share-popup-wrapper").remove();jQuery("#link-share-popup-wrapper").remove();helpers.failureMessagePopup("Upload Failed","You have already uploaded this file to server.")}}})}else{uploadFunction(type,callback,result)}}})};uploadFunction=(type,callback,result)=>{if(type=="manual"){jQuery("#quix-popup-loader").show()}let sessionData=result[`${extPrefix}quixyLoginUserData`];let canvas=document.getElementById("padding-screen");source=editScreenshot.downloadScreenImg.src;let imgS=helpers.getImageSize(source);helpers.dataURItoBlob(source,res=>{helpers.addTitleAndSummaryPopup(function(itemTitle,itemSummary,tagIdList){if(!screenshotName.trim()){screenshotName="untitled-"+Math.floor(1e4+Math.random()*9999)}let fd=new FormData;fd.append("name",screenshotName+".jpg");fd.append("access_token",result[`${extPrefix}quixyLoginUserData`]?.access_token);fd.append("user_id",parseInt(sessionData.id));fd.append("file_size",imgS);fd.append("screenshot",res);fd.append("title",itemTitle);fd.append("summary",itemSummary);fd.append("tags",tagIdList);helpers.makeServerRequest("POST","form-data",helpers.api+"/screenshots/upload",fd,res=>{if(res.responseJSON){res=res.responseJSON}else{res=res}if(type=="manual"){jQuery("#quix-popup-loader").hide()}if(res.status){if(callback!==undefined){callback(res)}uploadScreenShotCount++;isScreenshotUpdated=false;editScreenshot.needUploadScreanshotToServer=false;let data={[`${extPrefix}isScreenshotUploadedToServer`]:res.insertedId};chrome.storage.local.set(data,()=>{});if(type=="manual"){helpers.successMessagePopup("Uploaded Successfully","Screenshot is uploaded Successfully.")}}else{if(res.message=="You exceeded Limit."){jQuery("#email-share-popup-wrapper").remove();jQuery("#link-share-popup-wrapper").remove();helpers.failureMessagePopup("Upload Failed","You have reached max upload limit.")}else{jQuery("#email-share-popup-wrapper").remove();jQuery("#link-share-popup-wrapper").remove();helpers.failureMessagePopup("Upload Failed","Something Went Wrong.")}}})})})};