class captureScreenshotSG{constructor(){this.actionSave="";this.cropPoints=0;this.highlightStartPos="";this.prevHighlightStartPos="";this.ctxH="";this.highlightLastPoint="";this.selectedShapeAnno="";this.shapeOutline="3";this.shapeOutlineColor="#525FB0";this.canvas_background=null;this.isCanvasBackground=0;this.screenshotName="";this.uploadTypeSettings=false;this.start={};this.end={};this.isSelecting=false;this.winH=0;this.wScrolled=0;this.docHeight=0;this.scrollableElement=null;this.baseImgArr=[];this.imagesposY=0;this.lastScreenshotH=0;this.fullScreenShotCan="";this.fullScreenShotContext="";this.capturedFirstItem=0;this.requestSentToCaptureScreen=0;this.requestReceivedOnceScreenCaptured=0;this.isReachedScreenshotlimit=0;this.cropIcon=chrome.runtime.getURL("/images/quix-croptool-icon.png");this.closeIcon=chrome.runtime.getURL("/images/quix-close-icon.png");this.rect={};this.ctx="";this.drag="";this.fullSLoaderINT="";this.fullPageStickyFixedElems=[];this.fullPageStickyFixedBottomElems=[];this.extPrefix="SG_"}get_image=async(coords,callback)=>{let data=coords;let proceed=true;if(proceed){chrome.runtime.sendMessage({message:"wait"},response=>{});let dataUrl=data[6];let img=new Image;img.src=dataUrl;img.onload=()=>{let resize_canvas=document.createElement("canvas");let resize_canvas_width=data[4];let resize_canvas_height=data[5];resize_canvas.width=resize_canvas_width;resize_canvas.height=resize_canvas_height;resize_canvas.style.width=resize_canvas_width;resize_canvas.style.height=resize_canvas_height;let resize_context=resize_canvas.getContext("2d");resize_context.drawImage(img,0,0,img.width,img.height,0,0,resize_canvas_width,resize_canvas_height);let resized_img=new Image;resized_img.src=resize_canvas.toDataURL("image/jpeg",1);resized_img.onload=()=>{let canvas=document.createElement("canvas");canvas.setAttribute("id","visible_screen");canvas.height=data[3];canvas.width=data[2];canvas.style.height=data[3];canvas.style.width=data[2];let context=canvas.getContext("2d");context.drawImage(resized_img,data[0],data[1],data[2],data[3],0,0,data[2],data[3]);let imageURI=canvas.toDataURL("image/jpeg",1);callback(imageURI)}}}else{alert("Select a valid region to perform text extraction.");this.canvas_background=null;this.isCanvasBackground=0;return}};get_coords_screenshot=async(dataUri,callback)=>{this.disableScrolling();if(document.getElementById(this.extPrefix+"canvas_background")){document.getElementById(this.extPrefix+"canvas_background").remove();jQuery("#"+this.extPrefix+"close-captureScreen").unbind("click");jQuery("#"+this.extPrefix+"close-captureScreen").remove()}setTimeout(()=>{this.canvas_background=document.createElement("canvas");this.canvas_background.id=this.extPrefix+"canvas_background";this.canvas_background.style.width=window.innerWidth;this.canvas_background.style.height=window.innerHeight;this.canvas_background.width=window.innerWidth;this.canvas_background.height=window.innerHeight;this.canvas_background.style.position="absolute";this.canvas_background.style.left=0;this.canvas_background.style.top=window.scrollY+"px";this.canvas_background.style.zIndex="9999999999";this.canvas_background.style.cursor="crosshair";document.body.appendChild(this.canvas_background);let closeCapture='<span id="'+this.extPrefix+'close-captureScreen" style="top:'+(window.scrollY+10)+'px;"><img src="'+this.closeIcon+'"></span>';jQuery("body").append(closeCapture);jQuery("#"+this.extPrefix+"close-captureScreen").unbind("click");jQuery("#"+this.extPrefix+"close-captureScreen").on("click",()=>{jQuery("#"+this.extPrefix+"canvas_background").remove();jQuery("#"+this.extPrefix+"quix-screen-capture-outer").remove();this.canvas_background=null;this.isCanvasBackground=0;jQuery("#"+this.extPrefix+"close-captureScreen").unbind("click");jQuery("#"+this.extPrefix+"close-captureScreen").remove();this.enableScroll();this.enableScrolling()});this.ctx=this.canvas_background.getContext("2d");this.ctx.fillStyle="rgba(0, 0, 0, .7)";this.ctx.fillRect(0,0,window.innerWidth,window.innerHeight);this.ctx.font="30px Arial";this.ctx.textAlign="center";this.ctx.fillStyle="white";this.ctx.fillText("Select Your Area to Capture Screenshot",this.canvas_background.width/2,window.innerHeight/2);this.drag=false;this.init("screenshot");this.rect.startX=parseFloat(this.rect.startX);this.rect.startY=parseFloat(this.rect.startY);this.rect.w=parseFloat(this.rect.w);this.rect.h=parseFloat(this.rect.h);document.getElementById(this.extPrefix+"canvas_background").addEventListener("click",()=>{let xxCord=this.rect.startX+this.rect.w-85;let yyCord=this.rect.startY+this.rect.h+window.scrollY-40;let screenCaptureControls='<div id="'+this.extPrefix+'quix-screen-capture-outer" style="left:'+xxCord+"px;top:"+yyCord+'px;"><img id="'+this.extPrefix+'quix-screen-capture-close" src="'+this.closeIcon+'"><img id="'+this.extPrefix+'quix-screen-capture-crop" src="'+this.cropIcon+'"></div>';jQuery("body").append(screenCaptureControls);jQuery("#"+this.extPrefix+"quix-screen-capture-close").unbind("click");jQuery("#"+this.extPrefix+"quix-screen-capture-close").on("click",()=>{jQuery("#"+this.extPrefix+"canvas_background").remove();jQuery("#"+this.extPrefix+"quix-screen-capture-outer").remove();this.canvas_background=null;this.isCanvasBackground=0;this.enableScroll();jQuery("#"+this.extPrefix+"quix-screen-capture-close").unbind("click");jQuery("#"+this.extPrefix+"close-captureScreen").unbind("click");jQuery("#"+this.extPrefix+"close-captureScreen").remove();this.enableScrolling()});jQuery("#"+this.extPrefix+"quix-screen-capture-crop").unbind("click");jQuery("#"+this.extPrefix+"quix-screen-capture-crop").on("click",()=>{this.screenshotCropDrawnImage("screenshot",dataUri,callback);jQuery("#"+this.extPrefix+"canvas_background").remove();this.canvas_background=null;this.isCanvasBackground=0;this.enableScroll();jQuery("#quix-screen-capture").unbind("click");jQuery("#"+this.extPrefix+"quix-screen-capture-outer").remove();jQuery("#"+this.extPrefix+"close-captureScreen").unbind("click");jQuery("#"+this.extPrefix+"close-captureScreen").remove()})})},500)};screenshotCropDrawnImage=(type,dataUri,callback)=>{this.removeOverlay("screenshot").then(()=>{this.get_image([this.rect.startX,this.rect.startY,this.rect.w,this.rect.h,window.innerWidth,window.innerHeight,dataUri],imageURI=>{callback(imageURI)});jQuery("#"+this.extPrefix+"close-captureScreen").unbind("click");jQuery("#"+this.extPrefix+"close-captureScreen").remove();this.canvas_background=null;this.isCanvasBackground=0})};disableScrolling=()=>{let x=window.scrollX;let y=window.scrollY;window.onscroll=()=>{window.scroll(x,y)}};enableScrolling=()=>{window.onscroll=()=>{}};disableScroll=()=>{document.body.style.overflow="hidden"};enableScroll=()=>{document.body.style.overflow="visible"};init=type=>{this.canvas_background=document.getElementById(this.extPrefix+"canvas_background");if(type=="screenshot"&&this.canvas_background!==null){this.disableScroll();this.canvas_background.addEventListener("mousedown",this.mouseDownScreenshot,false);this.canvas_background.addEventListener("mouseup",this.mouseUp,false);this.canvas_background.addEventListener("mousemove",this.mouseMoveScreenshot,false);let mouseLeft=false;let mouseUpOccurred=false;jQuery("body").unbind("mouseover").on("mouseover",()=>{mouseLeft=false;window.mouseComingFromOut=false});jQuery("body").unbind("mouseleave").on("mouseleave",()=>{mouseLeft=true});window.addEventListener("mouseup",()=>{mouseUpOccurred=true;checkMouseUpAndLeave()},false);const checkMouseUpAndLeave=()=>{if(mouseLeft&&mouseUpOccurred){this.mouseUp();document.getElementById(this.extPrefix+"canvas_background").click();mouseLeft=false;mouseUpOccurred=false}}}};mouseDownScreenshot=e=>{this.disableScroll();this.canvas_background=document.getElementById(this.extPrefix+"canvas_background");this.rect.startX=e.clientX;this.rect.startY=e.clientY;this.drag=true;jQuery("#"+this.extPrefix+"close-captureScreen").css("display","none");jQuery("#"+this.extPrefix+"quix-screen-capture-outer").remove()};mouseUp=event=>{this.drag=false};mouseMoveScreenshot=e=>{if(this.drag){this.canvas_background=jQuery("#"+this.extPrefix+"canvas_background").offset();this.rect.w=e.pageX-this.canvas_background.left-this.rect.startX;this.rect.h=e.pageY-this.canvas_background.top-this.rect.startY;this.draw("screenshot")}};draw=type=>{let winWid=window.innerWidth;let winHei=window.innerHeight;if(type=="crop"){winWid=jQuery("#captured-screen").width();winHei=jQuery("#captured-screen").height();this.cropDimensionsWrite(parseInt(this.rect.startX),parseInt(this.rect.startY),this.rect.w,this.rect.h)}if(this.rect.startX<this.rect.startX+this.rect.w&&this.rect.startY<this.rect.startY+this.rect.h){this.ctx.fillStyle="rgba(0, 0, 0, .7)";this.ctx.clearRect(0,0,winWid,winHei);this.ctx.strokeStyle="#525FB0";this.ctx.lineWidth=3;this.ctx.fillRect(0,0,winWid,this.rect.startY);this.ctx.fillRect(0,this.rect.startY,this.rect.startX,winHei-this.rect.startY);this.ctx.fillRect(this.rect.startX,this.rect.startY+this.rect.h,winWid-this.rect.startX,winHei-this.rect.startY-this.rect.h);this.ctx.fillRect(this.rect.startX+this.rect.w,this.rect.startY,winWid-this.rect.startX-this.rect.w,this.rect.h);this.ctx.strokeRect(this.rect.startX,this.rect.startY,this.rect.w,this.rect.h);this.ctx.stroke()}};removeOverlay=async type=>{this.canvas_background=document.getElementById(this.extPrefix+"canvas_background");if(this.canvas_background!==null){this.ctx.clearRect(0,0,this.canvas_background.width,this.canvas_background.height);if(type=="screenshot"){document.body.removeChild(this.canvas_background)}else if(type=="crop"){document.getElementById("screenshot-wrapper-bottom-wrap-inner").removeChild(this.canvas_background)}}this.enableScrolling()};captureFullScreenshotsRequest=request=>{let data={watermarkSettings:""};chrome.storage.local.set(data,()=>{});let data1={needToAppyWatermarkSettings:{status:false}};chrome.storage.local.set(data1,()=>{});let data2={accountWaterMarkSettings:""};chrome.storage.local.set(data2,()=>{});screenShotType="Full Page";if(this.capturedFirstItem==0){this.resetScreenFeatures();this.capturedFirstItem=1;this.captureFirstTime();this.fullSLoaderINT=setInterval(()=>{let winScrolledY=jQuery("html").scrollTop();let totDocHeight=document.body.clientHeight;let width=parseInt(winScrolledY/totDocHeight*100);if(width<5){width=5}chrome.runtime.sendMessage({type:"progressLoader",width:width})},500)}};captureScreenshotsRequest=request=>{let data={watermarkSettings:""};chrome.storage.local.set(data,()=>{});let data1={needToAppyWatermarkSettings:{status:false}};chrome.storage.local.set(data1,()=>{});let data2={accountWaterMarkSettings:""};chrome.storage.local.set(data2,()=>{});if(request.event==2){screenShotType="Visible Part";if(request.uploadType!="Local"){this.uploadTypeSettings=true}this.resetScreenFeatures();this.handleCaptureVisibleScreen(request.dataUri)}if(request.event==4){screenShotType="Uploaded";if(request.uploadType!="Local"){this.uploadTypeSettings=true}this.resetScreenFeatures();this.handleCaptureVisibleScreen(request.dataUri)}else if(request.event==3){this.isCanvasBackground+=1;screenShotType="Selected Area";if(request.uploadType!="Local"){this.uploadTypeSettings=true}if(this.isCanvasBackground>0&&this.isCanvasBackground<2){this.resetScreenFeatures();this.handleCaptureSelectedScreen(request.dataUri)}}};captureFirstTime=async()=>{let _this=this;jQuery("body").css({overflow:"hidden","pointer-events":"none",height:"auto"});this.requestSentToCaptureScreen=this.requestSentToCaptureScreen+1;const stickyElems=await this.hideNearBottomStickyFixedElements();let getDocHeight=await this.getDocumentHeightAndScrollableElement();this.scrollableElement=getDocHeight.scrollableElement;if(getDocHeight.height<=window.innerHeight){chrome.runtime.sendMessage({type:"captureVisibleAreaNoScrollPresent"});jQuery("body").css({"pointer-events":"auto",overflow:"auto"});return}this.scrollableElement.scrollTo(0,0);jQuery(this.scrollableElement).css({overflow:"hidden","pointer-events":"none"});function handleVisibilityChange(){if(document.hidden){jQuery(_this.scrollableElement).css({"pointer-events":"auto",overflow:"auto"});clearInterval(_this.fullSLoaderINT);document.removeEventListener("visibilitychange",handleVisibilityChange)}}document.addEventListener("visibilitychange",handleVisibilityChange);setTimeout(()=>{this.winH=this.scrollableElement.clientHeight||window.innerHeight;this.docHeight=getDocHeight.height;chrome.runtime.sendMessage({type:"nextFrame"})},500)};hideNearBottomStickyFixedElements=async()=>{let elements=document.querySelectorAll("*");let viewportHeight=window.innerHeight;let fullPageStickyFixedElemFilter=Array.from(elements).filter(element=>{let computedStyle=getComputedStyle(element);let position=computedStyle.position;let visibility=computedStyle.visibility;if((position==="fixed"||position==="sticky")&&visibility==="visible"){let top=parseInt(computedStyle.top,10);let bottom=parseInt(computedStyle.bottom,10);if(!isNaN(bottom)&&top>viewportHeight-100||bottom>viewportHeight-100&&!(top<50)){element.style.visibility="hidden";this.fullPageStickyFixedBottomElems.push(element);return false}return true}return false});return fullPageStickyFixedElemFilter};getDocumentHeightAndScrollableElement=async()=>{var body=document.body;var html=document.documentElement;var documentHeight=Math.max(body.scrollHeight,body.offsetHeight,html.clientHeight,html.scrollHeight,html.offsetHeight);var scrollableElement=null;var maxScrollableHeight=0;var allElements=document.querySelectorAll("*");allElements.forEach(function(element){if(element.scrollHeight>element.clientHeight){var scrollableHeight=element.scrollHeight;var offsetTop=element.offsetTop;if(scrollableHeight+offsetTop>documentHeight){documentHeight=scrollableHeight+offsetTop}if(scrollableHeight>maxScrollableHeight){maxScrollableHeight=scrollableHeight;scrollableElement=element}}});return{height:documentHeight,scrollableElement:scrollableElement}};scrollWindowManual=()=>{let winScrolledX=jQuery("html").scrollLeft();let winScrolledY=jQuery("html").scrollTop();if(this.winH>0){setTimeout(()=>{this.wScrolled=this.wScrolled+this.winH;if(this.wScrolled<this.docHeight&&this.baseImgArr.length<=30){if(this.wScrolled+this.winH>this.docHeight){this.lastScreenshotH=this.docHeight-this.wScrolled;if(this.fullPageStickyFixedBottomElems.length>0){this.fullPageStickyFixedBottomElems.map((elem,idx)=>{$(elem).css({visibility:"visible"})})}}this.scrollableElement.scrollTo(0,this.wScrolled);setTimeout(()=>{let elements=document.querySelectorAll("*");let fullPageStickyFixedElemFilter=Array.from(elements).filter(element=>{return(getComputedStyle(element).position==="fixed"||getComputedStyle(element).position==="sticky")&&getComputedStyle(element).visibility==="visible"&&!this.fullPageStickyFixedBottomElems.includes(element)});if(fullPageStickyFixedElemFilter.length>0){fullPageStickyFixedElemFilter.forEach(element=>{element.style.visibility="hidden";this.fullPageStickyFixedElems.push(element);let childElements=element.querySelectorAll("*");childElements.forEach(child=>{let childComputedStyle=getComputedStyle(child);if(childComputedStyle.visibility==="visible"){child.style.visibility="hidden";this.fullPageStickyFixedElems.push(child)}})})}setTimeout(()=>{this.requestSentToCaptureScreen=this.requestSentToCaptureScreen+1;chrome.runtime.sendMessage({type:"nextFrame"})},1e3)},300)}else{if(this.wScrolled<this.docHeight){this.isReachedScreenshotlimit=1}let fullScreenInt=setInterval(()=>{if(this.requestSentToCaptureScreen==this.requestReceivedOnceScreenCaptured){clearInterval(fullScreenInt);if(this.fullPageStickyFixedElems.length>0){this.fullPageStickyFixedElems.map((elem,idx)=>{$(elem).css({visibility:"visible"})})}jQuery("body").css({"pointer-events":"auto",overflow:"auto"});jQuery(this.scrollableElement).css({"pointer-events":"auto",overflow:"auto"});this.fullScreenCaptured()}},500)}},500)}else{let checkForWInH=setInterval(()=>{this.winH=window.innerHeight;let getDocHeight=this.getDocumentHeightAndScrollableElement();this.docHeight=getDocHeight.height;this.scrollableElement=getDocHeight.scrollableElement;if(this.winH>0){clearInterval(checkForWInH);this.scrollWindowManual()}},500)}};lastScreenCaptured=()=>{this.fullScreenShotCan=document.createElement("canvas");let image=new Image;image.onload=()=>{if(this.isReachedScreenshotlimit<=0){this.lastScreenshotH=this.lastScreenshotH-parseInt((this.winH-image.height)/this.winH*this.lastScreenshotH);let canvas=document.createElement("canvas");canvas.height=this.lastScreenshotH;canvas.width=image.width;let context=canvas.getContext("2d");context.drawImage(image,0,image.height-this.lastScreenshotH,image.width,this.lastScreenshotH,0,0,image.width,this.lastScreenshotH);let screenCap=canvas.toDataURL("image/jpeg",1);let lastItemKey=this.baseImgArr.length-1;if(screenCap!==undefined&&screenCap!="data:,"&&lastItemKey>=0){this.baseImgArr[lastItemKey]=screenCap;this.fullScreenShotCan.height=image.height*(this.baseImgArr.length-1)+this.lastScreenshotH}}else{this.fullScreenShotCan.height=image.height*this.baseImgArr.length}this.fullScreenShotCan.width=image.width;this.fullScreenShotContext=this.fullScreenShotCan.getContext("2d");this.concatinateImagesCallback(image.height,this.winH,true)};image.src=this.baseImgArr[this.baseImgArr.length-1]};fullScreenCaptured=()=>{if(this.baseImgArr.length>1){this.lastScreenCaptured()}else if(this.baseImgArr.length==1){if(this.baseImgArr[0]!==undefined&&this.baseImgArr[0]!==""){clearInterval(this.fullSLoaderINT);this.capturedFirstItem=0;chrome.runtime.sendMessage({type:"openNewTab",screen:this.baseImgArr[0],originalImage:this.baseImgArr[0],screenshotName:this.screenshotName,screenshotUploadServer:this.uploadTypeSettings});chrome.runtime.sendMessage({type:"closePopupWindow"})}else{alert("Screenshot capture failed for this screen.")}}};concatinateImagesCallback=(imgHeight,winHeight,isFirstTime)=>{if(this.baseImgArr.length>0){if(!isFirstTime){this.imagesposY=this.imagesposY+imgHeight}this.concatinateImagesIntoOne(this.baseImgArr[0],this.imagesposY,imgHeight,winHeight,this.concatinateImagesCallback)}else{let fullscreen=this.fullScreenShotCan.toDataURL("image/jpeg",1);if(fullscreen!==undefined&&fullscreen!==""){clearInterval(this.fullSLoaderINT);this.capturedFirstItem=0;chrome.runtime.sendMessage({type:"openNewTab",screen:fullscreen,originalImage:fullscreen,screenshotName:this.screenshotName});chrome.runtime.sendMessage({type:"closePopupWindow"})}else{alert("Screenshot capture failed for this screen.")}}};concatinateImagesIntoOne=(base64img,yPos,imgHeight,winHeight,callback)=>{let image=new Image;image.onload=()=>{this.fullScreenShotContext.drawImage(image,0,yPos);this.baseImgArr.shift();callback(imgHeight,winHeight,false)};image.src=base64img};resetScreenFeatures=()=>{this.winH=0;this.wScrolled=0;this.docHeight=0;this.baseImgArr=[];this.imagesposY=0;this.lastScreenshotH=0;this.fullScreenShotCan="";this.fullScreenShotContext="";this.capturedFirstItem=0;this.requestSentToCaptureScreen=0;this.requestReceivedOnceScreenCaptured=0;this.isReachedScreenshotlimit=0;jQuery("#download-overlay").remove();jQuery(".download-screenshot").unbind("click");jQuery(".download-screenshot-full").unbind("click");jQuery(".close-download").unbind("click")};handleCaptureVisibleScreen=dataUri=>{if(dataUri!==undefined&&dataUri!==""){chrome.runtime.sendMessage({type:"openNewTab",screen:dataUri,originalImage:dataUri,screenshotName:this.screenshotName,screenshotUploadServer:this.uploadTypeSettings})}else{alert("Screenshot capture failed for this screen.")}};handleCaptureSelectedScreen=dataUri=>{let _this=this;this.get_coords_screenshot(dataUri,function(imageURI){if(imageURI!==undefined&&imageURI!==""){chrome.runtime.sendMessage({type:"openNewTab",screen:imageURI,originalImage:imageURI,screenshotName:_this.screenshotName,screenshotUploadServer:_this.uploadTypeSettings})}else{alert("Screenshot capture failed for this screen.")}})};clearFinalScreenshot=()=>{let data={[`${helpers.extPrefix}quixyScreenshotFinal`]:""};chrome.storage.local.set(data,()=>{})}}